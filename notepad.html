<script>
	$(function() {
		var files = [];
		function getFile(name) {
			var _file;
			files.forEach(function(file, index) {
				if (name == file[0]) {
					_file = file;
				}
			});
			return _file;
		}
		function updateFiles(name) {
			$('.notepad-files-button').each(function() {
				if ($(this).text() == name) {
					$(this).css('background-color', '#FFFFFF');
					var sL = $('#notepad-files').scrollLeft();
					var oL = $('#notepad-files').offset().left;
					var oW = $('#notepad-files').outerWidth() / 2;
					var fL = $(this).offset().left;
					var fW = $(this).outerWidth() / 2;
					$('#notepad-files').scrollLeft(sL - oL - oW + fL + fW);
				} else {
					$(this).css('background-color', '#CCCCCC');
				}
			});
		}
		function setFile(data) {
			if (typeof data == 'string' || typeof data == 'object') {
				var name;
				var value;
				if (typeof data == 'string') {
					name = data;
					value = getFile(data)[1];
				} else if (typeof data == 'object') {
					name = data[0];
					value = data[1];
				}
				
				sessionStorage.setItem('current-file', name);
				
				$('.notepad-files-button').each(function() {
					if ($(this).text() == name) {
						$(this).css('background-color', '#FFFFFF');
						$(this).css('z-index', '4');
						var sL = $('#notepad-files').scrollLeft();
						var oL = $('#notepad-files').offset().left;
						var oW = $('#notepad-files').outerWidth() / 2;
						var fL = $(this).offset().left;
						var fW = $(this).outerWidth() / 2;
						$('#notepad-files').scrollLeft(sL - oL - oW + fL + fW);
					} else {
						$(this).css('background-color', '#CCCCCC');
						$(this).css('z-index', '1');
					}
				});
				updateFiles(name);
				
				$('#notepad-textarea').show();
				$('#notepad-textarea').html(value);
				$('#notepad-textarea').focus();
			} else {
				sessionStorage.setItem('current-file', 'null');
				
				$('#notepad-textarea').html('');
				$('#notepad-textarea').hide();
			}
		}
		function curFile(name) {
			if (name != null) {
				if (name == '') {
					if (getFile(sessionStorage.getItem('current-file'))) {
						setFile(sessionStorage.getItem('current-file'));
					} else if (files[0]) {
						setFile(files[0]);
					} else {
						setFile();
					}
				} else {
					if (getFile(name)) {
						setFile(name);
					} else if (files[0]) {
						setFile(files[0]);
					} else {
						setFile();
					}
				}
			}
			return sessionStorage.getItem('current-file');
		}
		function saveFiles() {
			localStorage.setItem('notepad-files', JSON.stringify(files));
		}
		function newFile(name) {
			if (!name || name == '' || typeof name != 'string' || !name.trim()) {
				var next = 0;
				name = 'Note' + next;
				var gotNext = 0;
				while (!gotNext) {
					gotNext = 1;
					files.forEach(function(file, index) {
						if (name == file[0]) {
							next += 1;
							name = 'Note' + next;
							gotNext = 0;
						}
					});
				}
				files.push([name, '']);
				$('#notepad-files').append("<div class='notepad-files-button text'>" + name + '</div>');
				$('.notepad-files-button').click(function() {
					curFile($(this).text());
				});
				curFile(name);
			} else {
				var found = 0;
				files.forEach(function(file, index) {
					if (name == file[0]) {
						found = 1;
					}
				});
				if (!found) {
					files.push([name, '']);
					$('#notepad-files').append("<div class='notepad-files-button text'>" + name + '</div>');
					$('.notepad-files-button').click(function() {
						curFile($(this).text());
					});
					curFile(name);
				}
			}
			saveFiles();
		}
		function editFile(name, newName) {
			if (typeof newName == 'string' && newName.trim()) {
				files.forEach(function(file, index) {
					if (name == file[0]) {
						files[index][0] = newName;
						$('.notepad-files-button').each(function() {
							if ($(this).text() == name) {
								$(this).text(newName);
							}
						});
					}
				});
			}
			saveFiles();
		}
		function swapFiles(name1, name2) { // W.I.P.
			if (typeof newName == 'string' && newName.trim()) {
				var file1, file2;
				files.forEach(function(file, index) {
					if (name1 == file[0]) {
						$('.notepad-files-button').each(function() {
							if ($(this).text() == name1) {
								file1 = [file, index, this];
							}
						});
					} else if (name2 == file[0]) {
						$('.notepad-files-button').each(function() {
							if ($(this).text() == name2) {
								file2 = [file, index, this];
							}
						});
					}
				});
				if (file1 && file2) {
					files[file1[1]] = file2[0]
					file1[2].text(name2);
					files[file2[1]] = file1[0]
					file2[2].text(name1);
				}
			}
			saveFiles();
		}
		function deleteFile(name) {
			if (name != null) {
				$('.notepad-files-button').each(function() {
					if ($(this).text() == name) {
						curFile(($(this).prev() && $(this).prev().text()) || ($(this).next() && $(this).next().text()));
						$(this).remove();
					}
				});
				files.splice($.inArray(getFile(name), files), 1);
				saveFiles();
				curFile('');
			}
		}
		function loadFiles() {
			files = JSON.parse(localStorage.getItem('notepad-files'));
			if (files == null) {
				files = [];
			}
			files.forEach(function(file, index) {
				if ((file[0] != null)) {
					$('.notepad-files-button').each(function() {
						if ($(this).text() == file[0]) {
							$(this).remove();
						}
					});
					$('#notepad-files').append("<div class='notepad-files-button text'>" + file[0] + '</div>');
					$('.notepad-files-button').click(function() {
						curFile($(this).text());
					});
				} else {
					files.splice(index, 1);
				}
			});
			saveFiles();
		}
		
		var mousedown;
		$('#notepad-files-left').mousedown(function(event) {
			event.preventDefault();
			$('#notepad-files').scrollLeft($('#notepad-files').scrollLeft() - 1);
			mousedown = setInterval(function() {
				$('#notepad-files').scrollLeft($('#notepad-files').scrollLeft() - 1);
				$('#notepad-files').scrollLeft($('#notepad-files').scrollLeft() - 1);
			}, 1);
		});
		$('#notepad-files-right').mousedown(function(event) {
			event.preventDefault();
			$('#notepad-files').scrollLeft($('#notepad-files').scrollLeft() + 1);
			mousedown = setInterval(function() {
				$('#notepad-files').scrollLeft($('#notepad-files').scrollLeft() + 1);
				$('#notepad-files').scrollLeft($('#notepad-files').scrollLeft() + 1);
			}, 1);
		});
		$(document).mouseup(function() {
			clearInterval(mousedown);
		});
		
		$('.notepad-files-button').click(function(event) {
			event.preventDefault();
			curFile($(this).text());
			setFile(curFile());
			saveFiles();
		});
		$('#notepad-new').click(function(event) {
			event.preventDefault();
			$('<p>Add New Note</p>').prompt(function(e) {
				if (e.response) {
					newFile(e.response);
					setFile(curFile());
					saveFiles();
				}
				$('#notepad-textarea').focus();
			}, false, false, 'Enter note name...');
		});
		$('#notepad-edit').click(function(event) {
			event.preventDefault();
			var file = curFile();
			if (file != 'null') {
				$('<p>Edit Note Name: ' + file + '</p>').prompt(function(e) {
					if (e.response) {
						editFile(file, e.response);
						curFile(e.response);
					}
					$('#notepad-textarea').focus();
				}, false, false, 'Enter new note name...');
			}
		});
		$('#notepad-delete').click(function(event) {
			event.preventDefault();
			var file = curFile();
			if (file != 'null') {
				$('<p>Delete: ' + curFile() + '</p>').confirm(function(e) {
					if (e.response) {
						deleteFile(curFile());
						saveFiles();
					}
					$('#notepad-textarea').focus();
				}, false, false);
			}
		});
		$('#notepad-delete-all').click(function(event) {
			event.preventDefault();
			if (files[0]) {
				$('<p>Delete All Notes</p>').confirm(function(e) {
					if (e.response) {
						files = [];
						$('.notepad-files-button').remove();
						setFile();
						saveFiles();
					}
					$('#notepad-textarea').focus();
				}, false, false);
			}
		});
		
		function readonly(r) {
			if (typeof r == 'boolean') {
				if (r) {
					sessionStorage.setItem('notepad-read-only', '1');
					$('#notepad-textarea').attr('contenteditable', 'false');
					$('#notepad-read-only').css('background-color', '#222222');
				} else {
					sessionStorage.setItem('notepad-read-only', '0');
					$('#notepad-textarea').attr('contenteditable', 'true');
					$('#notepad-read-only').css('background-color', '');
				}
			}
			return ($('#notepad-textarea').attr('contenteditable') == 'false');
		}
		var _r = sessionStorage.getItem('notepad-read-only');
		if (typeof _r == 'string') {
			if (_r == '1') {
				readonly(true);
			} else if (_r == '0') {
				readonly(false);
			}
		} else {
			readonly(false);
		}
		$('#notepad-read-only').click(function(event) {
			event.preventDefault();
			if (readonly()) {
				readonly(false);
			} else {
				readonly(true);
			}
		});
		function spellcheck(s) {
			if (typeof s == 'boolean') {
				if (s) {
					sessionStorage.setItem('notepad-spellcheck', '1');
					$('#notepad-textarea').attr('spellcheck', 'true');
					$('#notepad-spellcheck').css('background-color', '#222222');
				} else {
					sessionStorage.setItem('notepad-spellcheck', '0');
					$('#notepad-textarea').attr('spellcheck', 'false');
					$('#notepad-spellcheck').css('background-color', '');
				}
			}
			return ($('#notepad-textarea').attr('spellcheck') == 'true');
		}
		var _s = sessionStorage.getItem('notepad-spellcheck');
		if (typeof _s == 'string') {
			if (_s == '1') {
				spellcheck(true);
			} else if (_s == '0') {
				spellcheck(false);
			}
		} else {
			spellcheck(true);
		}
		$('#notepad-spellcheck').click(function(event) {
			event.preventDefault();
			if (spellcheck()) {
				spellcheck(false);
			} else {
				spellcheck(true);
			}
		});
		function wrap(w) {
			if (typeof w == 'boolean') {
				if (w) {
					sessionStorage.setItem('notepad-wrap', '1');
					$('#notepad-textarea').css('white-space', 'pre-wrap')
					$('#notepad-wrap').css('background-color', '#222222');
				} else {
					sessionStorage.setItem('notepad-wrap', '0');
					$('#notepad-textarea').css('white-space', 'pre')
					$('#notepad-wrap').css('background-color', '');
				}
			}
			return ($('#notepad-textarea').css('white-space') == 'pre-wrap');
		}
		var _w = sessionStorage.getItem('notepad-wrap');
		if (typeof _w == 'string') {
			if (_w == '1') {
				wrap(true);
			} else if (_w == '0') {
				wrap(false);
			}
		} else {
			wrap(true);
		}
		$('#notepad-wrap').click(function(event) {
			event.preventDefault();
			if (wrap()) {
				wrap(false);
			} else {
				wrap(true);
			}
		});
		
		function command(event, command, element, testOnly) {
			if (event) {
				event.preventDefault();
			}
			if (!readonly()) {
				if (!testOnly) {
					document.execCommand(command);
				}
				if (document.queryCommandState(command)) {
					$(element).css('background-color', '#222222');
				} else {
					$(element).css('background-color', '');
				}
			}
		}
		function commandValue(event, command, value, element, testOnly) {
			if (event) {
				event.preventDefault();
			}
			if (!readonly()) {
				if (!testOnly) {
					document.execCommand(command, false, value);
				}
				var _value = document.queryCommandValue(command);
				if (_value) {
					$(element).text(_value);
				} else if (value) {
					$(element).text(value);
				}
			}
		}
		function checkCommands() {
			commandValue(null, 'fontSize', '3', $('#notepad-font-size'), true);
			command(null, 'bold', $('#notepad-bold'), true);
			command(null, 'italic', $('#notepad-italic'), true);
			command(null, 'underline', $('#notepad-underline'), true);
			command(null, 'strikethrough', $('#notepad-strikethrough'), true);
			command(null, 'insertOrderedList', $('#notepad-ordered-list'), true);
			command(null, 'insertUnorderedList', $('#notepad-unordered-list'), true);
			command(null, 'superscript', $('#notepad-superscript'), true);
			command(null, 'subscript', $('#notepad-subscript'), true);
			command(null, 'justifyLeft', $('#notepad-align-left'), true);
			command(null, 'justifyCenter', $('#notepad-align-center'), true);
			command(null, 'justifyRight', $('#notepad-align-right'), true);
			command(null, 'justifyFull', $('#notepad-align-justify'), true);
		}
		
		function getFonts() {
			$('#notepad-font-name-expand-menu').html('');
			var fontJSON, fontStatus;
			var request = new XMLHttpRequest();
			request.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					fontJSON = JSON.parse(this.responseText);
				} else {
					fontStatus = this.status;
				}
			};
			request.open('GET', 'https://www.googleapis.com/webfonts/v1/webfonts?key=AIzaSyAGTtTykgLQAA_GpFHIcLiCC21IBd1pwvw', true);
			request.send();
			if (fontJSON) {
				var i = 0;
				var l = fontJSON.items.length;
				var fonts, ff;
				while (i < l) {
					fonts = '';
					for (j = i; j < (i + 100); j++) {
						if (j >= l) { break; }
						ff = fontJSON.items[j].family;
						if (fonts != '') {fonts += '|';}
						if (ff == 'Buda' || ff == 'Open Sans Condensed') { ff = ff + ':300'; }
						if (ff == 'Coda Caption') { ff = 'Coda Caption:800'; }
						if (ff == 'UnifrakturCook') { ff = 'UnifrakturCook:700'; }
						fonts += ff;
					}
					$('#notepad-font-name-expand-menu').append("<div class='notepad-font-name-expand-menu-item notepad-menu-item'>" + fonts + "</div>");
					i = i + 100;
				}
			} else {
				console.error('Google Fonts request failed with status ' + fontStatus + '.');
			}
		}
		$('#notepad-font-name-expand').click(function() {
			$('#notepad-font-name-expand-menu').toggle();
			if ($('#notepad-font-name-expand-menu').is(':visible')) {
				getFonts();
				$(this).css('background-color', '#CCCCCC');
			} else {
				$(this).css('background-color', '');
			}
		});
		$('.notepad-font-name-expand-menu-item').click(function() {
			commandValue(event, 'fontName', $(this).text(), $('#notepad-font-name'));
			$('#notepad-font-name-expand-menu').hide();
			$('#notepad-font-name-expand').css('background-color', '');
		});
		$('#notepad-font-size-expand').click(function() {
			$('#notepad-font-size-expand-menu').toggle();
			if ($('#notepad-font-size-expand-menu').is(':visible')) {
				$(this).css('background-color', '#CCCCCC');
			} else {
				$(this).css('background-color', '');
			}
		});
		$('.notepad-font-size-expand-menu-item').click(function() {
			commandValue(event, 'fontSize', $(this).text(), $('#notepad-font-size'));
			$('#notepad-font-size-expand-menu').hide();
			$('#notepad-font-size-expand').css('background-color', '');
		});
		$('#notepad-increase-font').click(function(event) {
			commandValue(event, 'fontSize', parseInt(document.queryCommandValue('fontSize')) + 1, $('#notepad-font-size'));
		});
		$('#notepad-decrease-font').click(function(event) {
			commandValue(event, 'fontSize', parseInt(document.queryCommandValue('fontSize')) - 1, $('#notepad-font-size'));
		});
		
		$('#notepad-bold').click(function(event) {
			command(event, 'bold', this);
			checkCommands(event);
		});
		$('#notepad-italic').click(function(event) {
			command(event, 'italic', this);
			checkCommands(event);
		});
		$('#notepad-underline').click(function(event) {
			command(event, 'underline', this);
			checkCommands(event);
		});
		$('#notepad-strikethrough').click(function(event) {
			command(event, 'strikethrough', this);
			checkCommands(event);
		});
		$('#notepad-superscript').click(function(event) {
			command(event, 'superscript', this);
			checkCommands();
		});
		$('#notepad-subscript').click(function(event) {
			command(event, 'subscript', this);
			checkCommands();
		});
		
		$('#notepad-ordered-list').click(function(event) {
			command(event, 'insertOrderedList', this);
			checkCommands();
		});
		$('#notepad-unordered-list').click(function(event) {
			command(event, 'insertUnorderedList', this);
			checkCommands();
		});
		
		$('#notepad-align-left').click(function() {
			command(event, 'justifyLeft', this);
			checkCommands();
		});
		$('#notepad-align-center').click(function() {
			command(event, 'justifyCenter', this);
			checkCommands();
		});
		$('#notepad-align-right').click(function() {
			command(event, 'justifyRight', this);
			checkCommands();
		});
		$('#notepad-align-justify').click(function() {
			command(event, 'justifyFull', this);
			checkCommands();
		});
		
		$(document).on('selectionchange', function() {
			checkCommands();
		});
		
		$('#notepad-erase').click(function(event) {
			event.preventDefault();
			var file = curFile();
			if (file != 'null' && $('#notepad-textarea').html() != '') {
				$('<p>Erase Note: ' + file + '</p>').confirm(function(e) {
					if (e.response) {
						$('#notepad-textarea').html('');
					}
					$('#notepad-textarea').focus();
				}, false, false);
			}
		});
		
		$('#notepad-textarea').on('DOMSubtreeModified', function() {
			var file = getFile(curFile());
			if (file) {
				file[1] = $(this).html();
			}
			if ($('#notepad-textarea').html() == '') {
				$('#notepad-erase').css('background-color', '#222222');
			} else {
				$('#notepad-erase').css('background-color', '');
			}
			saveFiles();
		});
		
		$('#notepad-textarea').keydown(function(event) {
			if (event.which == 9) { // Tab
				event.preventDefault();
				document.execCommand('insertHTML', false, '&#009');
			} else if (event.which == 8 && ($('#notepad-textarea').html() == '<br>' || $('#notepad-textarea').html() == '<div><br></div>')) { // Backspace
				event.preventDefault();
				$('#notepad-textarea').html('');
			}
			saveFiles();
		});
		
		$(document).click(function(event) {
			if (!$('body').children('.jquery_prompt')[0]) {
				$('#notepad-textarea').focus();
			}
		});
		
		$(window).resize(function() {
			updateFiles(curFile());
		});
		
		$('#notepad-textarea').html('');
		$('#notepad-textarea').hide();
		
		loadFiles();
		curFile('');
		
		if ($('#notepad-textarea').html() == '') {
			$('#notepad-erase').css('background-color', '#222222');
		} else {
			$('#notepad-erase').css('background-color', '');
		}
	});
</script>

<div id='notepad-content'>
	<div id='notepad-bar'>
		<div id='notepad-bar-left'>
			<div class='notepad-bar-button-base'><img id='notepad-erase' class='notepad-bar-button' src='notepad/bar/erase.png'></div>
			<div class='notepad-bar-separator-base'><div class='notepad-bar-separator'></div></div>
			<div id='notepad-font-name-menu-base' class='notepad-menu-base notepad-bar-button-base'>
				<div id='notepad-font-name' class='notepad-menu notepad-bar-button'>sans-serif</div>
				<div id='notepad-font-name-expand' class='notepad-menu-expand'>
					<img class='notepad-menu-expand-img' src='notepad/bar/expand.png'>
				</div>
				<div id='notepad-font-name-expand-menu' class='notepad-menu-expand-menu' hidden></div>
			</div>
			<div id='notepad-font-size-menu-base' class='notepad-menu-base notepad-bar-button-base'>
				<div id='notepad-font-size' class='notepad-menu notepad-bar-button'>3</div>
				<div id='notepad-font-size-expand' class='notepad-menu-expand'>
					<img class='notepad-menu-expand-img' src='notepad/bar/expand.png'>
				</div>
				<div id='notepad-font-size-expand-menu' class='notepad-menu-expand-menu' hidden>
					<div class='notepad-font-size-expand-menu-item notepad-menu-item'>1</div>
					<div class='notepad-font-size-expand-menu-item notepad-menu-item'>2</div>
					<div class='notepad-font-size-expand-menu-item notepad-menu-item'>3</div>
					<div class='notepad-font-size-expand-menu-item notepad-menu-item'>4</div>
					<div class='notepad-font-size-expand-menu-item notepad-menu-item'>5</div>
					<div class='notepad-font-size-expand-menu-item notepad-menu-item'>6</div>
					<div class='notepad-font-size-expand-menu-item notepad-menu-item'>7</div>
				</div>
			</div>
			<div class='notepad-bar-button-base'><img id='notepad-increase-font' class='notepad-bar-button' src='notepad/bar/increase-font.png'></div>
			<div class='notepad-bar-button-base'><img id='notepad-decrease-font' class='notepad-bar-button' src='notepad/bar/decrease-font.png'></div>
			<div class='notepad-bar-separator-base'><div class='notepad-bar-separator'></div></div>
			<div class='notepad-bar-button-base'><img id='notepad-bold' class='notepad-bar-button' src='notepad/bar/bold.png'></div>
			<div class='notepad-bar-button-base'><img id='notepad-italic' class='notepad-bar-button' src='notepad/bar/italic.png'></div>
			<div class='notepad-bar-button-base'><img id='notepad-underline' class='notepad-bar-button' src='notepad/bar/underline.png'></div>
			<div class='notepad-bar-button-base'><img id='notepad-strikethrough' class='notepad-bar-button' src='notepad/bar/strikethrough.png'></div>
			<div class='notepad-bar-button-base'><img id='notepad-superscript' class='notepad-bar-button' src='notepad/bar/superscript.png'></div>
			<div class='notepad-bar-button-base'><img id='notepad-subscript' class='notepad-bar-button' src='notepad/bar/subscript.png'></div>
			<div class='notepad-bar-separator-base'><div class='notepad-bar-separator'></div></div>
			<div class='notepad-bar-button-base'><img id='notepad-ordered-list' class='notepad-bar-button' src='notepad/bar/ordered-list.png'></div>
			<div class='notepad-bar-button-base'><img id='notepad-unordered-list' class='notepad-bar-button' src='notepad/bar/unordered-list.png'></div>
			<div class='notepad-bar-separator-base'><div class='notepad-bar-separator'></div></div>
			<div class='notepad-bar-button-base'><img id='notepad-align-left' class='notepad-bar-button' src='notepad/bar/align-left.png'></div>
			<div class='notepad-bar-button-base'><img id='notepad-align-center' class='notepad-bar-button' src='notepad/bar/align-center.png'></div>
			<div class='notepad-bar-button-base'><img id='notepad-align-right' class='notepad-bar-button' src='notepad/bar/align-right.png'></div>
			<div class='notepad-bar-button-base'><img id='notepad-align-justify' class='notepad-bar-button' src='notepad/bar/align-justify.png'></div>
			<div class='notepad-bar-separator-base'><div class='notepad-bar-separator'></div></div>
			<div class='notepad-bar-button-base'><img id='notepad-read-only' class='notepad-bar-button' src='notepad/bar/read-only.png'></div>
			<div class='notepad-bar-button-base'><img id='notepad-spellcheck' class='notepad-bar-button' src='notepad/bar/spellcheck.png'></div>
			<div class='notepad-bar-button-base'><img id='notepad-wrap' class='notepad-bar-button' src='notepad/bar/wrap.png'></div>
		</div>
		<div id='notepad-bar-center'></div>
		<div id='notepad-bar-right'></div>
	</div>
	<img id='notepad-files-left' src='notepad/left.png'>
	<div id='notepad-files'></div>
	<img id='notepad-files-right' src='notepad/right.png'>
	<div id='notepad-files-bar'>
		<div class='notepad-files-bar-button-base'><img id='notepad-new' class='notepad-files-bar-button' src='notepad/new.png'></div>
		<div class='notepad-files-bar-button-base'><img id='notepad-edit' class='notepad-files-bar-button' src='notepad/edit.png'></div>
		<div class='notepad-files-bar-button-base'><img id='notepad-delete' class='notepad-files-bar-button' src='notepad/delete.png'></div>
		<div class='notepad-files-bar-button-base'><img id='notepad-delete-all' class='notepad-files-bar-button' src='notepad/delete-all.png'></div>
	</div>
	<div id='notepad-textarea-container'>
		<div id='notepad-textarea' class='text' placeholder='Enter note here...' contenteditable autofocus></div>
	</div>
</div>
