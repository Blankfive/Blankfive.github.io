<script>
	$(function() {
		var files = [];
		
		function getFile(name) {
			var _file;
			files.forEach(function(file, index) {
				if (name == file[0]) {
					_file = file;
				}
			});
			return _file;
		}
		
		function updateFiles(name) {
			$('.notepad-files-button').each(function() {
				if ($(this).text() == name) {
					$(this).css('background-color', '#FFFFFF');
					$(this).css('z-index', '4');
					var sL = $('#notepad-files').scrollLeft();
					var oL = $('#notepad-files').offset().left;
					var oW = $('#notepad-files').outerWidth() / 2;
					var fL = $(this).offset().left;
					var fW = $(this).outerWidth() / 2;
					$('#notepad-files').scrollLeft(sL - oL - oW + fL + fW);
				} else {
					$(this).css('background-color', '#CCCCCC');
					$(this).css('z-index', '1');
				}
			});
		}
		
		function setFile(data) {
			if (typeof data == 'string' || typeof data == 'object') {
				var name;
				var value;
				if (typeof data == 'string') {
					name = data;
					value = getFile(data)[1];
				} else if (typeof data == 'object') {
					name = data[0];
					value = data[1];
				}
				
				sessionStorage.setItem('current-file', name);
				
				$('.notepad-files-button').each(function() {
					if ($(this).text() == name) {
						$(this).css('background-color', '#FFFFFF');
						$(this).css('z-index', '4');
						var sL = $('#notepad-files').scrollLeft();
						var oL = $('#notepad-files').offset().left;
						var oW = $('#notepad-files').outerWidth() / 2;
						var fL = $(this).offset().left;
						var fW = $(this).outerWidth() / 2;
						$('#notepad-files').scrollLeft(sL - oL - oW + fL + fW);
					} else {
						$(this).css('background-color', '#CCCCCC');
						$(this).css('z-index', '1');
					}
				});
				updateFiles(name);
				
				$('#notepad-textarea').show();
				$('#notepad-textarea').val(value);
				$('#notepad-textarea').focus();
			} else {
				sessionStorage.setItem('current-file', 'null');
				
				$('#notepad-textarea').val('');
				$('#notepad-textarea').hide();
			}
		}
		
		function curFile(name) {
			if (name != null) {
				if (name == '') {
					if (getFile(sessionStorage.getItem('current-file'))) {
						setFile(sessionStorage.getItem('current-file'));
					} else if (files[0]) {
						setFile(files[0]);
					} else {
						setFile();
					}
				} else {
					if (getFile(name)) {
						setFile(name);
					} else if (files[0]) {
						setFile(files[0]);
					} else {
						setFile();
					}
				}
			}
			return sessionStorage.getItem('current-file');
		}
		
		function saveFiles() {
			localStorage.setItem('notepad-files', JSON.stringify(files));
		}
		
		function newFile(name) {
			if (!name || name == '' || typeof name != 'string' || !name.trim()) {
				var next = 0;
				name = 'Note' + next;
				var gotNext = 0;
				while (!gotNext) {
					gotNext = 1;
					files.forEach(function(file, index) {
						if (name == file[0]) {
							next += 1;
							name = 'Note' + next;
							gotNext = 0;
						}
					});
				}
				files.push([name, '']);
				$('#notepad-files').append("<div class='notepad-files-button text'>" + name + '</div>');
				$('.notepad-files-button').click(function() {
					curFile($(this).text());
				});
				curFile(name);
			} else {
				var found = 0;
				files.forEach(function(file, index) {
					if (name == file[0]) {
						found = 1;
					}
				});
				if (!found) {
					files.push([name, '']);
					$('#notepad-files').append("<div class='notepad-files-button text'>" + name + '</div>');
					$('.notepad-files-button').click(function() {
						curFile($(this).text());
					});
					curFile(name);
				}
			}
			saveFiles();
		}
		
		function editFile(name, newName) {
			if (typeof newName == 'string' && newName.trim()) {
				files.forEach(function(file, index) {
					if (name == file[0]) {
						files[index][0] = newName;
						$('.notepad-files-button').each(function() {
							if ($(this).text() == name) {
								$(this).text(newName);
							}
						});
					}
				});
			}
			saveFiles();
		}
		
		function deleteFile(name) {
			if (name != null) {
				$('.notepad-files-button').each(function() {
					if ($(this).text() == name) {
						curFile(($(this).prev() && $(this).prev().text()) || ($(this).next() && $(this).next().text()));
						$(this).remove();
					}
				});
				files.splice($.inArray(getFile(name), files), 1);
				saveFiles();
				curFile('');
			}
		}
		
		function loadFiles() {
			files = JSON.parse(localStorage.getItem('notepad-files'));
			if (files == null) {
				files = [];
			}
			files.forEach(function(file, index) {
				if ((file[0] != null)) {
					$('.notepad-files-button').each(function() {
						if ($(this).text() == file[0]) {
							$(this).remove();
						}
					});
					$('#notepad-files').append("<div class='notepad-files-button text'>" + file[0] + '</div>');
					$('.notepad-files-button').click(function() {
						curFile($(this).text());
					});
				} else {
					files.splice(index, 1);
				}
			});
			saveFiles();
		}
		
		var mousedown;
		$('#notepad-files-left').mousedown(function() {
			$('#notepad-files').scrollLeft($('#notepad-files').scrollLeft() - 1);
			mousedown = setInterval(function() {
				$('#notepad-files').scrollLeft($('#notepad-files').scrollLeft() - 1);
				$('#notepad-files').scrollLeft($('#notepad-files').scrollLeft() - 1);
			}, 1);
		});
		
		$('#notepad-files-right').mousedown(function() {
			$('#notepad-files').scrollLeft($('#notepad-files').scrollLeft() + 1);
			mousedown = setInterval(function() {
				$('#notepad-files').scrollLeft($('#notepad-files').scrollLeft() + 1);
				$('#notepad-files').scrollLeft($('#notepad-files').scrollLeft() + 1);
			}, 1);
		});
		
		$(document).mouseup(function() {
			clearInterval(mousedown);
		});
		
		$('.notepad-files-button').click(function() {
			curFile($(this).text());
			setFile(curFile());
			saveFiles();
		});
		
		$('#notepad-new').click(function() {
			$('<p>Add New Note</p>').prompt(function(e) {
				if (e.response) {
					newFile(e.response);
					setFile(curFile());
					saveFiles();
				}
			}, false, false, 'Enter note name...');
		});
		
		$('#notepad-edit').click(function() {
			var file = curFile();
			if (file != 'null') {
				$('<p>Edit Note Name: ' + file + '</p>').prompt(function(e) {
					if (e.response) {
						editFile(file, e.response);
						curFile(e.response);
					}
				}, false, false, 'Enter new note name...');
			}
		});
		
		$('#notepad-delete').click(function() {
			var file = curFile();
			if (file != 'null') {
				$('<p>Delete: ' + curFile() + '</p>').confirm(function(e) {
					if (e.response) {
						deleteFile(curFile());
						saveFiles();
					}
				}, false, false);
			}
		});
		
		$('#notepad-delete-all').click(function() {
			if (files[0]) {
				$('<p>Delete All Notes</p>').confirm(function(e) {
					if (e.response) {
						files = [];
						$('.notepad-files-button').remove();
						setFile();
						saveFiles();
					}
				}, false, false);
			}
		});
		
		$('#notepad-account').click(function() {});
		
		function wrap(w) {
			if (typeof w == 'boolean') {
				if (w) {
					sessionStorage.setItem('notepad-wrap', '1');
					$('#notepad-textarea').css('white-space', 'pre')
					$('#notepad-wrap').children('.notepad-bar-button-toggle').attr('src', 'notepad/on.png');
				} else {
					sessionStorage.setItem('notepad-wrap', '0');
					$('#notepad-textarea').css('white-space', 'pre-wrap')
					$('#notepad-wrap').children('.notepad-bar-button-toggle').attr('src', 'notepad/off.png');
				}
			}
			return ($('#notepad-textarea').css('white-space') == 'pre');
		}
		
		var _w = sessionStorage.getItem('notepad-wrap');
		if (typeof _w == 'string') {
			if (_w == '1') {
				wrap(true);
			} else if (_w == '0') {
				wrap(false);
			}
		} else {
			wrap(true);
		}
		
		$('#notepad-wrap').click(function() {
			if (wrap()) {
				wrap(false);
			} else {
				wrap(true);
			}
		});
		
		$('#notepad-textarea').on('keyup', function() {
			getFile(curFile())[1] = $(this).val();
			saveFiles('.notepad-bar-button-toggle');
		});
		
		$(window).resize(function() {
			updateFiles(curFile());
		});
		
		$('#notepad-textarea').val('');
		$('#notepad-textarea').hide();
		
		loadFiles();
		curFile('');
	});
</script>

<div id='notepad-content'>
	<div id='notepad-bar'>
		<img id='notepad-new' class='notepad-bar-button' src='notepad/new.png'>
		<img id='notepad-edit' class='notepad-bar-button' src='notepad/edit.png'>
		<img id='notepad-delete' class='notepad-bar-button' src='notepad/delete.png'>
		<img id='notepad-delete-all' class='notepad-bar-button' src='notepad/delete-all.png'>
		<div class='notepad-bar-separator'></div>
		<div id='notepad-wrap' class='notepad-bar-button'>
			<img class='notepad-bar-button-toggle-base' src='notepad/wrap.png'>
			<img class='notepad-bar-button-toggle' src='notepad/on.png'>
		</div>
	</div>
	<img id='notepad-files-left' src='notepad/left.png'>
	<div id='notepad-files'></div>
	<img id='notepad-files-right' src='notepad/right.png'>
	<div id='notepad-textarea-container'>
		<textarea id='notepad-textarea' class='text' placeholder='Enter note here...' autofocus></textarea>
	</div>
</div>
